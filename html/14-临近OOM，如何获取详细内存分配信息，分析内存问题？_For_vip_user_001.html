<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>14-ä¸´è¿‘OOMï¼Œå¦‚ä½•è·å–è¯¦ç»†å†…å­˜åˆ†é…ä¿¡æ¯ï¼Œåˆ†æå†…å­˜é—®é¢˜ï¼Ÿ</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
        <style>
        html {
            color: #333;
            -webkit-text-size-adjust: 100%;
            -ms-text-size-adjust: 100%;
            text-rendering: optimizelegibility;
            font-family: Helvetica Neue, PingFang SC, Verdana, Microsoft Yahei, Hiragino Sans GB, Microsoft Sans Serif, WenQuanYi Micro Hei, sans-serif
        }

        html.borderbox *,
        html.borderbox :after,
        html.borderbox :before {
            box-sizing: border-box
        }

        article,
        aside,
        blockquote,
        body,
        button,
        code,
        dd,
        details,
        dl,
        dt,
        fieldset,
        figcaption,
        figure,
        footer,
        form,
        h1,
        h2,
        h3,
        h4,
        h5,
        h6,
        header,
        hr,
        input,
        legend,
        li,
        menu,
        nav,
        ol,
        p,
        pre,
        section,
        td,
        textarea,
        th,
        ul {
            margin: 0;
            padding: 0
        }

        article,
        aside,
        details,
        figcaption,
        figure,
        footer,
        header,
        menu,
        nav,
        section {
            display: block
        }

        audio,
        canvas,
        video {
            display: inline-block
        }

        body,
        button,
        input,
        select,
        textarea {
            font: 300 1em/1.8 PingFang SC, Lantinghei SC, Microsoft Yahei, Hiragino Sans GB, Microsoft Sans Serif, WenQuanYi Micro Hei, Helvetica, sans-serif
        }

        button::-moz-focus-inner,
        input::-moz-focus-inner {
            padding: 0;
            border: 0
        }

        table {
            border-collapse: collapse;
            border-spacing: 0
        }

        fieldset,
        img {
            border: 0
        }

        blockquote {
            position: relative;
            color: #999;
            font-weight: 400;
            border-left: 1px solid #1abc9c;
            padding-left: 1em;
            margin: 1em 3em 1em 2em
        }

        @media only screen and (max-width: 640px) {
            blockquote {
                margin: 1em 0
            }
        }

        abbr,
        acronym {
            border-bottom: 1px dotted;
            font-variant: normal
        }

        abbr {
            cursor: help
        }

        del {
            text-decoration: line-through
        }

        address,
        caption,
        cite,
        code,
        dfn,
        em,
        th,
        var {
            font-style: normal;
            font-weight: 400
        }

        ol,
        ul {
            list-style: none
        }

        caption,
        th {
            text-align: left
        }

        q:after,
        q:before {
            content: ""
        }

        sub,
        sup {
            font-size: 75%;
            line-height: 0;
            position: relative
        }

        :root sub,
        :root sup {
            vertical-align: baseline
        }

        sup {
            top: -.5em
        }

        sub {
            bottom: -.25em
        }

        a {
            color: #1abc9c
        }

        a:hover {
            text-decoration: underline
        }

        .typo a {
            border-bottom: 1px solid #1abc9c
        }

        .typo a:hover {
            border-bottom-color: #555;
            color: #555
        }

        .typo a:hover,
        a,
        ins {
            text-decoration: none
        }

        .typo-u,
        u {
            text-decoration: underline
        }

        mark {
            background: #fffdd1;
            border-bottom: 1px solid #ffedce;
            padding: 2px;
            margin: 0 5px
        }

        code,
        pre,
        pre tt {
            font-family: Courier, Courier New, monospace
        }

        pre {
            background: hsla(0, 0%, 97%, .7);
            border: 1px solid #ddd;
            padding: 1em 1.5em;
            display: block;
            -webkit-overflow-scrolling: touch
        }

        hr {
            border: none;
            border-bottom: 1px solid #cfcfcf;
            margin-bottom: .8em;
            height: 10px
        }

        .typo-small,
        figcaption,
        small {
            font-size: .9em;
            color: #888
        }

        b,
        strong {
            font-weight: 700;
            color: #000
        }

        [draggable] {
            cursor: move
        }

        .clearfix:after,
        .clearfix:before {
            content: "";
            display: table
        }

        .clearfix:after {
            clear: both
        }

        .clearfix {
            zoom: 1
        }

        .textwrap,
        .textwrap td,
        .textwrap th {
            word-wrap: break-word;
            word-break: break-all
        }

        .textwrap-table {
            table-layout: fixed
        }

        .serif {
            font-family: Palatino, Optima, Georgia, serif
        }

        .typo-dl,
        .typo-form,
        .typo-hr,
        .typo-ol,
        .typo-p,
        .typo-pre,
        .typo-table,
        .typo-ul,
        .typo dl,
        .typo form,
        .typo hr,
        .typo ol,
        .typo p,
        .typo pre,
        .typo table,
        .typo ul,
        blockquote {
            margin-bottom: 1rem
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
            font-family: PingFang SC, Helvetica Neue, Verdana, Microsoft Yahei, Hiragino Sans GB, Microsoft Sans Serif, WenQuanYi Micro Hei, sans-serif;
            color: #000;
            line-height: 1.35
        }

        .typo-h1,
        .typo-h2,
        .typo-h3,
        .typo-h4,
        .typo-h5,
        .typo-h6,
        .typo h1,
        .typo h2,
        .typo h3,
        .typo h4,
        .typo h5,
        .typo h6 {
            margin-top: 1.2em;
            margin-bottom: .6em;
            line-height: 1.35
        }

        .typo-h1,
        .typo h1 {
            font-size: 2em
        }

        .typo-h2,
        .typo h2 {
            font-size: 1.8em
        }

        .typo-h3,
        .typo h3 {
            font-size: 1.6em
        }

        .typo-h4,
        .typo h4 {
            font-size: 1.4em
        }

        .typo-h5,
        .typo-h6,
        .typo h5,
        .typo h6 {
            font-size: 1.2em
        }

        .typo-ul,
        .typo ul {
            margin-left: 1.3em;
            list-style: disc
        }

        .typo-ol,
        .typo ol {
            list-style: decimal;
            margin-left: 1.9em
        }

        .typo-ol ol,
        .typo-ol ul,
        .typo-ul ol,
        .typo-ul ul,
        .typo li ol,
        .typo li ul {
            margin-bottom: .8em;
            margin-left: 2em
        }

        .typo-ol ul,
        .typo-ul ul,
        .typo li ul {
            list-style: circle
        }

        .typo-table td,
        .typo-table th,
        .typo table caption,
        .typo table td,
        .typo table th {
            border: 1px solid #ddd;
            padding: .5em 1em;
            color: #666
        }

        .typo-table th,
        .typo table th {
            background: #fbfbfb
        }

        .typo-table thead th,
        .typo table thead th {
            background: hsla(0, 0%, 95%, .7)
        }

        .typo table caption {
            border-bottom: none
        }

        .typo-input,
        .typo-textarea {
            -webkit-appearance: none;
            border-radius: 0
        }

        .typo-em,
        .typo em,
        caption,
        legend {
            color: #000;
            font-weight: inherit
        }

        .typo-em {
            position: relative
        }

        .typo-em:after {
            position: absolute;
            top: .65em;
            left: 0;
            width: 100%;
            overflow: hidden;
            white-space: nowrap;
            content: "\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB"
        }

        .typo img {
            max-width: 100%
        }

        .common-content {
            font-weight: 400;
            color: #353535;
            line-height: 1.75rem;
            white-space: normal;
            word-break: normal;
            font-size: 1rem
        }

        .common-content img {
            display: block;
            max-width: 100%;
            background-color: #eee
        }

        .common-content audio,
        .common-content video {
            width: 100%;
            background-color: #eee
        }

        .common-content center,
        .common-content font {
            margin-top: 1rem;
            display: inline-block
        }

        .common-content center {
            width: 100%
        }

        .common-content pre {
            margin-top: 1rem;
            padding-left: 0;
            padding-right: 0;
            position: relative;
            overflow: hidden
        }

        .common-content pre code {
            font-size: .8rem;
            font-family: Consolas, Liberation Mono, Menlo, monospace, Courier;
            display: block;
            width: 100%;
            box-sizing: border-box;
            padding-left: 1rem;
            padding-right: 1rem;
            overflow-x: auto
        }

        .common-content hr {
            border: none;
            margin-top: 1.5rem;
            margin-bottom: 1.5rem;
            border-top: 1px solid #f5f5f5;
            height: 1px;
            background: none
        }

        .common-content b,
        .common-content h1,
        .common-content h2,
        .common-content h3,
        .common-content h4,
        .common-content h5,
        .common-content strong {
            font-weight: 700
        }

        .common-content h1,
        .common-content h2 {
            font-size: 1.125rem;
            margin-bottom: .45rem
        }

        .common-content h3,
        .common-content h4,
        .common-content h5 {
            font-size: 1rem;
            margin-bottom: .45rem
        }

        .common-content p {
            font-weight: 400;
            color: #353535;
            margin-top: .15rem
        }

        .common-content .orange {
            color: #ff5a05
        }

        .common-content .reference {
            font-size: 1rem;
            color: #888
        }

        .custom-rich-content h1 {
            margin-top: 0;
            font-weight: 400;
            font-size: 15.25px;
            border-bottom: 1px solid #eee;
            line-height: 2.8
        }

        .custom-rich-content li,
        .custom-rich-content p {
            font-size: 14px;
            color: #888;
            line-height: 1.6
        }

        table.hljs-ln {
            margin-bottom: 0;
            border-spacing: 0;
            border-collapse: collapse
        }

        table.hljs-ln,
        table.hljs-ln tbody,
        table.hljs-ln td,
        table.hljs-ln tr {
            box-sizing: border-box
        }

        table.hljs-ln td {
            padding: 0;
            border: 0
        }

        table.hljs-ln td.hljs-ln-numbers {
            min-width: 15px;
            color: rgba(27, 31, 35, .3);
            text-align: right;
            white-space: nowrap;
            cursor: pointer;
            user-select: none
        }

        table.hljs-ln td.hljs-ln-code,
        table.hljs-ln td.hljs-ln-numbers {
            font-family: SFMono-Regular, Consolas, Liberation Mono, Menlo, Courier, monospace;
            font-size: 12px;
            line-height: 20px;
            vertical-align: top
        }

        table.hljs-ln td.hljs-ln-code {
            position: relative;
            padding-right: 10px;
            padding-left: 10px;
            overflow: visible;
            color: #24292e;
            word-wrap: normal;
            white-space: pre
        }

        video::-webkit-media-controls {
            overflow: hidden !important
        }

        video::-webkit-media-controls-enclosure {
            width: calc(100% + 32px);
            margin-left: auto
        }

        ._29HP61GA_0 {
            max-width:800px;
            margin:0 auto;
            margin-bottom: 20px;
            font-weight: 400;
            color: #353535;
            line-height: 1.76;
            white-space: normal;
            word-break: normal;
            font-size: 17px;
            -webkit-transition: background-color .3s ease;
            transition: background-color .3s ease
        }

        ._29HP61GA_0 .MathJax_Display {
            overflow: auto
        }

        ._29HP61GA_0 .poster {
            position: fixed;
            left: -10000px;
            top: -10000px;
            overflow: hidden;
            padding: 1rem;
            background: #ececec
        }

        ._29HP61GA_0 .richcontent-pre-copy {
            font-size: 13px;
            color: #888;
            position: absolute;
            right: 1em;
            top: .5em;
            cursor: pointer;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none
        }

        ._29HP61GA_0 .richcontent-pre-copy .iconfont {
            font-size: 12px;
            margin-right: .2em
        }

        ._29HP61GA_0 a {
            color: #fa8919;
            border-bottom: 1px solid #fa8919
        }

        ._29HP61GA_0 img {
            display: block;
            max-width: 100%;
            position: relative;
            left: 50%;
            -webkit-transform: translateX(-50%);
            transform: translateX(-50%);
            background-color: #eee;
            vertical-align: top;
            border-radius: 0
        }

        ._29HP61GA_0 audio,
        ._29HP61GA_0 video {
            width: 100%;
            background-color: #eee
        }

        ._29HP61GA_0 pre {
            margin-top: 16px;
            padding: 34px 0 0;
            margin-bottom: 30px;
            position: relative;
            border-radius: 6px;
            background: rgba(246, 247, 251, .749);
            border: 0
        }

        ._29HP61GA_0 pre code {
            font-size: 12px;
            font-family: Consolas, Liberation Mono, Menlo, monospace, Courier;
            display: block;
            -webkit-box-sizing: border-box;
            box-sizing: border-box;
            margin-left: 16px;
            margin-right: 16px;
            overflow-x: scroll
        }

        ._29HP61GA_0 pre code:after {
            content: "";
            height: 30px;
            width: 100%;
            display: block
        }

        ._29HP61GA_0 hr {
            border: none;
            margin-top: 1.5rem;
            margin-bottom: 1.5rem;
            border-top: 1px solid #f5f5f5;
            height: 1px;
            background: none
        }

        ._29HP61GA_0 h1,
        ._29HP61GA_0 h2,
        ._29HP61GA_0 h3,
        ._29HP61GA_0 h4,
        ._29HP61GA_0 h5 {
            margin-bottom: 20px;
            margin-top: 0;
            font-weight: 700
        }

        ._29HP61GA_0 b,
        ._29HP61GA_0 strong {
            font-weight: 700
        }

        ._29HP61GA_0 h1 {
            font-size: 21px
        }

        ._29HP61GA_0 h2 {
            font-size: 20px
        }

        ._29HP61GA_0 h3 {
            font-size: 19px
        }

        ._29HP61GA_0 h4 {
            font-size: 18px
        }

        ._29HP61GA_0 h5 {
            font-size: 17px
        }

        ._29HP61GA_0 center,
        ._29HP61GA_0 p {
            font-weight: 400;
            color: #353535;
            margin-top: 0;
            margin-bottom: 30px;
            word-break: break-word
        }

        ._29HP61GA_0 center {
            text-align: center
        }

        ._29HP61GA_0 blockquote {
            margin-top: 0;
            margin-bottom: 34px;
            border-left: 3px solid #e8e8e8;
            padding-left: 17px;
            color: #353535
        }

        ._29HP61GA_0 blockquote p {
            margin-top: 0;
            margin-bottom: 0
        }

        ._29HP61GA_0 ol,
        ._29HP61GA_0 ul {
            margin-bottom: 30px
        }

        ._29HP61GA_0 ol p,
        ._29HP61GA_0 ul p {
            margin-top: 0;
            margin-bottom: 0
        }

        ._29HP61GA_0 ol {
            list-style: decimal;
            margin-left: 20px
        }

        ._29HP61GA_0 ul li {
            padding-left: 17px;
            position: relative;
            margin-bottom: 10px
        }

        ._29HP61GA_0 ul li:after {
            content: "";
            height: 6px;
            width: 6px;
            border-radius: 50%;
            background: #353535;
            position: absolute;
            top: 10px;
            left: 0
        }

        ._29HP61GA_0 .orange {
            color: #fa8919
        }

        ._29HP61GA_0 .reference {
            color: #888
        }

        ._29HP61GA_0 .m-right {
            text-align: right
        }

        ._29HP61GA_0 .m-center {
            text-align: center;
            display: block
        }

        ._29HP61GA_0 .m-gray {
            color: #888
        }

        ._29HP61GA_0 .m-small {
            font-size: 15px
        }

        ._29HP61GA_0 table.hljs-ln {
            margin-bottom: 0;
            border-spacing: 0;
            border-collapse: collapse
        }

        ._29HP61GA_0 table.hljs-ln,
        ._29HP61GA_0 table.hljs-ln tbody,
        ._29HP61GA_0 table.hljs-ln td,
        ._29HP61GA_0 table.hljs-ln tr {
            -webkit-box-sizing: border-box;
            box-sizing: border-box
        }

        ._29HP61GA_0 table.hljs-ln td {
            padding: 0;
            border: 0
        }

        ._29HP61GA_0 table.hljs-ln td.hljs-ln-numbers {
            min-width: 15px;
            font-size: 12px;
            color: rgba(27, 31, 35, .3);
            text-align: right;
            white-space: nowrap;
            cursor: pointer;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none
        }

        ._29HP61GA_0 table.hljs-ln td.hljs-ln-code,
        ._29HP61GA_0 table.hljs-ln td.hljs-ln-numbers {
            font-family: SFMono-Regular, Consolas, Liberation Mono, Menlo, Courier, monospace;
            line-height: 20px;
            vertical-align: top
        }

        ._29HP61GA_0 table.hljs-ln td.hljs-ln-code {
            position: relative;
            padding-right: 10px;
            padding-left: 10px;
            overflow: visible;
            font-size: 13px;
            color: #666;
            word-wrap: normal;
            white-space: pre
        }

    </style>
</head>
<body>
<div class="_29HP61GA_0">
<h1>14-ä¸´è¿‘OOMï¼Œå¦‚ä½•è·å–è¯¦ç»†å†…å­˜åˆ†é…ä¿¡æ¯ï¼Œåˆ†æå†…å­˜é—®é¢˜ï¼Ÿ</h1>
<p>ä½ å¥½ï¼Œæˆ‘æ˜¯æˆ´é“­ã€‚ä»Šå¤©æˆ‘ä»¬æ¥èŠèŠï¼Œä¸´è¿‘OOMï¼Œå¦‚ä½•è·å–è¯¦ç»†çš„å†…å­˜åˆ†é…ä¿¡æ¯ï¼Œåˆ†æå†…å­˜é—®é¢˜çš„è¯é¢˜ã€‚</p><p>OOMï¼Œæ˜¯Out of Memoryçš„ç¼©å†™ï¼ŒæŒ‡çš„æ˜¯Appå ç”¨çš„å†…å­˜è¾¾åˆ°äº†iOSç³»ç»Ÿå¯¹å•ä¸ªAppå ç”¨å†…å­˜ä¸Šé™åï¼Œè€Œè¢«ç³»ç»Ÿå¼ºæ€æ‰çš„ç°è±¡ã€‚è¿™ä¹ˆè¯´çš„è¯ï¼ŒOOMå…¶å®ä¹Ÿå±äºæˆ‘ä»¬åœ¨ç¬¬12ç¯‡æ–‡ç« â€œ<a href="https://time.geekbang.org/column/article/88600">iOS å´©æºƒåƒå¥‡ç™¾æ€ªï¼Œå¦‚ä½•å…¨é¢ç›‘æ§ï¼Ÿ</a>â€ä¸­æåˆ°çš„åº”ç”¨â€œå´©æºƒâ€ä¸­çš„ä¸€ç§ï¼Œæ˜¯ç”±iOSçš„Jetsamæœºåˆ¶å¯¼è‡´çš„ä¸€ç§â€œå¦ç±»â€å´©æºƒï¼Œå¹¶ä¸”æ—¥å¿—æ— æ³•é€šè¿‡ä¿¡å·æ•æ‰åˆ°ã€‚</p><p>JetSamæœºåˆ¶ï¼ŒæŒ‡çš„å°±æ˜¯æ“ä½œç³»ç»Ÿä¸ºäº†æ§åˆ¶å†…å­˜èµ„æºè¿‡åº¦ä½¿ç”¨è€Œé‡‡ç”¨çš„ä¸€ç§èµ„æºç®¡æ§æœºåˆ¶ã€‚</p><p>æˆ‘ä»¬éƒ½çŸ¥é“ï¼Œç‰©ç†å†…å­˜å’Œ CPU å¯¹äºæ‰‹æœºè¿™æ ·çš„ä¾¿æºè®¾å¤‡æ¥è¯´ï¼Œå¯è°“ç¨€ç¼ºèµ„æºã€‚æ‰€ä»¥è¯´ï¼Œåœ¨iOS ç³»ç»Ÿçš„è™šæ‹Ÿå†…å­˜ç®¡ç†ä¸­ï¼Œå†…å­˜å‹åŠ›çš„ç®¡æ§å°±æ˜¯ä¸€é¡¹å¾ˆé‡è¦çš„å†…å®¹ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘å°±è·Ÿä½ ä»‹ç»ä¸€ä¸‹å¦‚ä½•è·å–å†…å­˜ä¸Šé™å€¼ï¼Œä»¥åŠå¦‚ä½•ç›‘æ§åˆ°Appå› ä¸ºå ç”¨å†…å­˜è¿‡å¤§è€Œè¢«å¼ºæ€çš„é—®é¢˜ï¼Ÿ</p><h2>é€šè¿‡ JetsamEvent æ—¥å¿—è®¡ç®—å†…å­˜é™åˆ¶å€¼</h2><p>æƒ³è¦äº†è§£ä¸åŒæœºå™¨åœ¨ä¸åŒç³»ç»Ÿç‰ˆæœ¬çš„æƒ…å†µä¸‹ï¼Œå¯¹ App çš„å†…å­˜é™åˆ¶æ˜¯æ€æ ·çš„ï¼Œæœ‰ä¸€ç§æ–¹æ³•å°±æ˜¯æŸ¥çœ‹æ‰‹æœºä¸­ä»¥ JetsamEvent å¼€å¤´çš„ç³»ç»Ÿæ—¥å¿—ï¼ˆæˆ‘ä»¬å¯ä»¥ä»è®¾ç½®-&gt;éšç§-&gt;åˆ†æä¸­çœ‹åˆ°è¿™äº›æ—¥å¿—ï¼‰ã€‚</p><p>åœ¨è¿™äº›ç³»ç»Ÿæ—¥å¿—ä¸­ï¼ŒæŸ¥æ‰¾å´©æºƒåŸå› æ—¶æˆ‘ä»¬éœ€è¦å…³æ³¨ per-process-limit éƒ¨åˆ†çš„ rpagesã€‚rpages è¡¨ç¤ºçš„æ˜¯ ï¼ŒApp å ç”¨çš„å†…å­˜é¡µæ•°é‡ï¼›per-process-limit è¡¨ç¤ºçš„æ˜¯ï¼ŒApp å ç”¨çš„å†…å­˜è¶…è¿‡äº†ç³»ç»Ÿå¯¹å•ä¸ªApp çš„å†…å­˜é™åˆ¶ã€‚</p><!-- [[[read_end]]] --><p>è¿™éƒ¨åˆ†æ—¥å¿—çš„ç»“æ„å¦‚ä¸‹ï¼š</p><pre><code>&quot;rpages&quot; : 89600,
&quot;reason&quot; : &quot;per-process-limit&quot;,
</code></pre><p>ç°åœ¨ï¼Œæˆ‘ä»¬å·²ç»çŸ¥é“äº†å†…å­˜é¡µæ•°é‡  rpages ä¸º 89600ï¼Œåªè¦å†çŸ¥é“å†…å­˜é¡µå¤§å°çš„å€¼ï¼Œå°±å¯ä»¥è®¡ç®—å‡ºç³»ç»Ÿå¯¹å•ä¸ªAppé™åˆ¶çš„å†…å­˜æ˜¯å¤šå°‘äº†ã€‚</p><p>å†…å­˜é¡µå¤§å°çš„å€¼ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨ JetsamEvent å¼€å¤´çš„ç³»ç»Ÿæ—¥å¿—é‡Œæ‰¾åˆ°ï¼Œä¹Ÿå°±æ˜¯pageSizeçš„å€¼ã€‚å¦‚ä¸‹å›¾çº¢æ¡†éƒ¨åˆ†æ‰€ç¤ºï¼š</p><p><img src="https://static001.geekbang.org/resource/image/f6/2a/f60391e3109494b411cef7d936b4792a.png" alt=""><br>
å¯ä»¥çœ‹åˆ°ï¼Œå†…å­˜é¡µå¤§å° pageSize çš„å€¼æ˜¯16384ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±å¯ä»¥è®¡ç®—å‡ºå½“å‰ App çš„å†…å­˜é™åˆ¶å€¼ï¼špageSize * rpages / 1024 /1024 =16384 * 89600 / 1024 / 1024 å¾—åˆ°çš„å€¼æ˜¯ 1400 MBï¼Œå³ 1.4Gã€‚</p><p>è¿™äº› JetsamEvent æ—¥å¿—ï¼Œéƒ½æ˜¯ç³»ç»Ÿåœ¨æ€æ‰ App åç•™åœ¨æ‰‹æœºé‡Œçš„ã€‚åœ¨æŸ¥çœ‹è¿™äº›æ—¥å¿—æ—¶ï¼Œæˆ‘ä»¬å°±ä¼šå‘ç°ï¼Œå¾ˆå¤šæ—¥å¿—éƒ½æ˜¯ iOS ç³»ç»Ÿå†…æ ¸å¼ºæ€æ‰é‚£äº›ä¼˜å…ˆçº§ä¸é«˜ï¼Œå¹¶ä¸”å ç”¨çš„å†…å­˜è¶…è¿‡é™åˆ¶çš„ App åç•™ä¸‹çš„ã€‚</p><p>è¿™äº›æ—¥å¿—å±äºç³»ç»Ÿçº§çš„ï¼Œä¼šå­˜åœ¨ç³»ç»Ÿç›®å½•ä¸‹ã€‚Appä¸Šçº¿åå¼€å‘è€…æ˜¯æ²¡æœ‰æƒé™è·å–åˆ°ç³»ç»Ÿç›®å½•å†…å®¹çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œè¢«å¼ºæ€æ‰çš„ App æ˜¯æ— æ³•è·å–åˆ°ç³»ç»Ÿçº§æ—¥å¿—çš„ï¼Œåªèƒ½çº¿ä¸‹è®¾å¤‡é€šè¿‡è¿æ¥ Xcode è·å–åˆ°è¿™éƒ¨åˆ†æ—¥å¿—ã€‚è·å–åˆ°Jetsam åï¼Œå°±èƒ½å¤Ÿç®—å‡ºç³»ç»Ÿå¯¹ App è®¾ç½®çš„å†…å­˜é™åˆ¶å€¼ã€‚</p><p>é‚£ä¹ˆï¼Œ<strong>iOSç³»ç»Ÿæ˜¯æ€ä¹ˆå‘ç° Jetsam çš„å‘¢ï¼Ÿ</strong></p><p>iOS ç³»ç»Ÿä¼šå¼€å¯ä¼˜å…ˆçº§æœ€é«˜çš„çº¿ç¨‹ vm_pressure_monitor æ¥ç›‘æ§ç³»ç»Ÿçš„å†…å­˜å‹åŠ›æƒ…å†µï¼Œå¹¶é€šè¿‡ä¸€ä¸ªå †æ ˆæ¥ç»´æŠ¤æ‰€æœ‰ App çš„è¿›ç¨‹ã€‚å¦å¤–ï¼ŒiOSç³»ç»Ÿè¿˜ä¼šç»´æŠ¤ä¸€ä¸ªå†…å­˜å¿«ç…§è¡¨ï¼Œç”¨äºä¿å­˜æ¯ä¸ªè¿›ç¨‹å†…å­˜é¡µçš„æ¶ˆè€—æƒ…å†µã€‚</p><p>å½“ç›‘æ§ç³»ç»Ÿå†…å­˜çš„çº¿ç¨‹å‘ç°æŸ App å†…å­˜æœ‰å‹åŠ›äº†ï¼Œå°±å‘å‡ºé€šçŸ¥ï¼Œå†…å­˜æœ‰å‹åŠ›çš„ App å°±ä¼šå»æ‰§è¡Œå¯¹åº”çš„ä»£ç†ï¼Œä¹Ÿå°±æ˜¯ä½ æ‰€ç†Ÿæ‚‰çš„ didReceiveMemoryWarning ä»£ç†ã€‚é€šè¿‡è¿™ä¸ªä»£ç†ï¼Œä½ å¯ä»¥è·å¾—æœ€åä¸€ä¸ªç¼–å†™é€»è¾‘ä»£ç é‡Šæ”¾å†…å­˜çš„æœºä¼šã€‚è¿™æ®µä»£ç çš„æ‰§è¡Œï¼Œå°±æœ‰å¯èƒ½ä¼šé¿å…ä½ çš„Appè¢«ç³»ç»Ÿå¼ºæ€ã€‚</p><p>ç³»ç»Ÿåœ¨å¼ºæ€Appå‰ï¼Œä¼šå…ˆåšä¼˜å…ˆçº§åˆ¤æ–­ã€‚é‚£ä¹ˆï¼Œè¿™ä¸ª<strong>ä¼˜å…ˆçº§åˆ¤æ–­çš„ä¾æ®æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</strong></p><p>iOSç³»ç»Ÿå†…æ ¸é‡Œæœ‰ä¸€ä¸ªæ•°ç»„ï¼Œä¸“é—¨ç”¨äºç»´æŠ¤çº¿ç¨‹çš„ä¼˜å…ˆçº§ã€‚è¿™ä¸ªä¼˜å…ˆçº§è§„å®šå°±æ˜¯ï¼šå†…æ ¸ç”¨çº¿ç¨‹çš„ä¼˜å…ˆçº§æ˜¯æœ€é«˜çš„ï¼Œæ“ä½œç³»ç»Ÿçš„ä¼˜å…ˆçº§å…¶æ¬¡ï¼ŒApp çš„ä¼˜å…ˆçº§æ’åœ¨æœ€åã€‚å¹¶ä¸”ï¼Œå‰å° App ç¨‹åºçš„ä¼˜å…ˆçº§æ˜¯é«˜äºåå°è¿è¡Œ App çš„ï¼›çº¿ç¨‹ä½¿ç”¨ä¼˜å…ˆçº§æ—¶ï¼ŒCPU å ç”¨å¤šçš„çº¿ç¨‹çš„ä¼˜å…ˆçº§ä¼šè¢«é™ä½ã€‚</p><p>iOSç³»ç»Ÿåœ¨å› ä¸ºå†…å­˜å ç”¨åŸå› å¼ºæ€æ‰Appå‰ï¼Œè‡³å°‘æœ‰6ç§’é’Ÿçš„æ—¶é—´å¯ä»¥ç”¨æ¥åšä¼˜å…ˆçº§åˆ¤æ–­ã€‚åŒæ—¶ï¼ŒJetSamEventæ—¥å¿—ä¹Ÿæ˜¯åœ¨è¿™6ç§’å†…ç”Ÿæˆçš„ã€‚</p><p>é™¤äº†JetSamEventæ—¥å¿—å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡XNUæ¥è·å–å†…å­˜çš„é™åˆ¶å€¼ã€‚</p><h2>é€šè¿‡ XNU è·å–å†…å­˜é™åˆ¶å€¼</h2><p>åœ¨ XNU ä¸­ï¼Œæœ‰ä¸“é—¨ç”¨äºè·å–å†…å­˜ä¸Šé™å€¼çš„å‡½æ•°å’Œå®ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ memorystatus_priority_entry è¿™ä¸ªç»“æ„ä½“ï¼Œå¾—åˆ°è¿›ç¨‹çš„ä¼˜å…ˆçº§å’Œå†…å­˜é™åˆ¶å€¼ã€‚ç»“æ„ä½“ä»£ç å¦‚ä¸‹ï¼š</p><pre><code>typedef struct memorystatus_priority_entry {
	pid_t pid;
	int32_t priority;
	uint64_t user_data;
	int32_t limit;
	uint32_t state;
} memorystatus_priority_entry_t;
</code></pre><p>åœ¨è¿™ä¸ªç»“æ„ä½“ä¸­ï¼Œpriority è¡¨ç¤ºçš„æ˜¯è¿›ç¨‹çš„ä¼˜å…ˆçº§ï¼Œlimitå°±æ˜¯æˆ‘ä»¬æƒ³è¦çš„è¿›ç¨‹å†…å­˜é™åˆ¶å€¼ã€‚</p><h2>é€šè¿‡å†…å­˜è­¦å‘Šè·å–å†…å­˜é™åˆ¶å€¼</h2><p>é€šè¿‡XNU çš„å®è·å–å†…å­˜é™åˆ¶ï¼Œéœ€è¦æœ‰ root æƒé™ï¼Œè€ŒApp å†…çš„æƒé™æ˜¯ä¸å¤Ÿçš„ï¼Œæ‰€ä»¥æ­£å¸¸æƒ…å†µä¸‹ï¼Œä½œä¸ºAppå¼€å‘è€…ä½ æ˜¯çœ‹ä¸åˆ°è¿™ä¸ªä¿¡æ¯çš„ã€‚é‚£ä¹ˆï¼Œå¦‚æœä½ ä¸æƒ³è¶Šç‹±å»è·å–è¿™ä¸ªæƒé™çš„è¯ï¼Œè¿˜å¯ä»¥åˆ©ç”¨ didReceiveMemoryWarning è¿™ä¸ªå†…å­˜å‹åŠ›ä»£ç†äº‹ä»¶æ¥åŠ¨æ€åœ°è·å–å†…å­˜é™åˆ¶å€¼ã€‚</p><p>iOSç³»ç»Ÿåœ¨å¼ºæ€æ‰Appä¹‹å‰è¿˜æœ‰6ç§’é’Ÿçš„æ—¶é—´ï¼Œè¶³å¤Ÿä½ å»è·å–è®°å½•å†…å­˜ä¿¡æ¯äº†ã€‚é‚£ä¹ˆï¼Œ<strong>å¦‚ä½•è·å–å½“å‰å†…å­˜ä½¿ç”¨æƒ…å†µå‘¢ï¼Ÿ</strong></p><p>iOSç³»ç»Ÿæä¾›äº†ä¸€ä¸ªå‡½æ•° task_infoï¼Œ å¯ä»¥å¸®åŠ©æˆ‘ä»¬è·å–åˆ°å½“å‰ä»»åŠ¡çš„ä¿¡æ¯ã€‚å…³é”®ä»£ç å¦‚ä¸‹ï¼š</p><pre><code>struct mach_task_basic_info info;
mach_msg_type_number_t size = sizeof(info);
kern_return_t kl = task_info(mach_task_self(), MACH_TASK_BASIC_INFO, (task_info_t)&amp;info, &amp;size);
</code></pre><p>ä»£ç ä¸­ï¼Œtask_info_t ç»“æ„é‡ŒåŒ…å«äº†ä¸€ä¸ªresident_size å­—æ®µï¼Œç”¨äºè¡¨ç¤ºä½¿ç”¨äº†å¤šå°‘å†…å­˜ã€‚è¿™æ ·ï¼Œæˆ‘ä»¬å°±å¯ä»¥è·å–åˆ°å‘ç”Ÿå†…å­˜è­¦å‘Šæ—¶ï¼Œå½“å‰App å ç”¨äº†å¤šå°‘å†…å­˜ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><pre><code>float used_mem = info.resident_size;
NSLog(@&quot;ä½¿ç”¨äº† %f MB å†…å­˜&quot;, used_mem / 1024.0f / 1024.0f)
</code></pre><h2>å®šä½å†…å­˜é—®é¢˜ä¿¡æ¯æ”¶é›†</h2><p>ç°åœ¨ï¼Œæˆ‘ä»¬å·²ç»å¯ä»¥é€šè¿‡ä¸‰ç§æ–¹æ³•æ¥è·å–å†…å­˜ä¸Šé™å€¼äº†ï¼Œè€Œä¸”é€šè¿‡å†…å­˜è­¦å‘Šçš„æ–¹å¼è¿˜èƒ½å¤ŸåŠ¨æ€åœ°è·å–åˆ°è¿™ä¸ªå€¼ã€‚æœ‰äº†è¿™ä¸ªå†…å­˜ä¸Šé™å€¼ä»¥åï¼Œä½ å°±å¯ä»¥è¿›è¡Œå†…å­˜é—®é¢˜çš„ä¿¡æ¯æ”¶é›†å·¥ä½œäº†ã€‚</p><p>è¦æƒ³ç²¾ç¡®åœ°å®šä½é—®é¢˜ï¼Œæˆ‘ä»¬å°±éœ€è¦ dump å‡ºå®Œæ•´çš„å†…å­˜ä¿¡æ¯ï¼ŒåŒ…æ‹¬æ‰€æœ‰å¯¹è±¡åŠå…¶å†…å­˜å ç”¨å€¼ï¼Œåœ¨å†…å­˜æ¥è¿‘ä¸Šé™å€¼çš„æ—¶å€™ï¼Œæ”¶é›†å¹¶è®°å½•ä¸‹æ‰€éœ€ä¿¡æ¯ï¼Œå¹¶åœ¨åˆé€‚çš„æ—¶æœºä¸ŠæŠ¥åˆ°æœåŠ¡å™¨é‡Œï¼Œæ–¹ä¾¿åˆ†æé—®é¢˜ã€‚</p><p>è·å–åˆ°äº†æ¯ä¸ªå¯¹è±¡çš„å†…å­˜å ç”¨é‡è¿˜ä¸å¤Ÿï¼Œä½ è¿˜éœ€è¦çŸ¥é“æ˜¯è°åˆ†é…çš„å†…å­˜ï¼Œè¿™æ ·æ‰å¯ä»¥ç²¾ç¡®å®šä½åˆ°é—®é¢˜çš„å…³é”®æ‰€åœ¨ã€‚ä¸€ä¸ªå¯¹è±¡å¯èƒ½ä¼šåœ¨ä¸åŒçš„å‡½æ•°é‡Œè¢«åˆ†é…äº†å†…å­˜å¹¶è¢«åˆ›å»ºäº†å‡ºæ¥ï¼Œå½“è¿™ä¸ªå¯¹è±¡å†…å­˜å ç”¨è¿‡å¤§æ—¶ï¼Œå¦‚æœä¸çŸ¥é“æ˜¯åœ¨å“ªä¸ªå‡½æ•°é‡Œåˆ›å»ºçš„è¯ï¼Œé—®é¢˜ä¾ç„¶å¾ˆéš¾ç²¾ç¡®å®šä½å‡ºæ¥ã€‚é‚£ä¹ˆï¼Œ<strong>æ€æ ·æ‰èƒ½çŸ¥é“æ˜¯è°åˆ†é…çš„å†…å­˜å‘¢ï¼Ÿ</strong></p><p>è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘è§‰å¾—åº”è¯¥ä»æ ¹å„¿ä¸Šå»æ‰¾ç­”æ¡ˆã€‚å†…å­˜åˆ†é…å‡½æ•° malloc å’Œ calloc ç­‰é»˜è®¤ä½¿ç”¨çš„æ˜¯ nano_zoneã€‚nano_zone æ˜¯256Bä»¥ä¸‹å°å†…å­˜çš„åˆ†é…ï¼Œå¤§äº256B çš„æ—¶å€™ä¼šä½¿ç”¨ scalable_zone æ¥åˆ†é…ã€‚</p><p>åœ¨è¿™é‡Œï¼Œæˆ‘ä¸»è¦æ˜¯é’ˆå¯¹å¤§å†…å­˜çš„åˆ†é…ç›‘æ§ï¼Œæ‰€ä»¥åªé’ˆå¯¹ scalable_zone è¿›è¡Œåˆ†æï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥è¿‡æ»¤æ‰å¾ˆå¤šå°å†…å­˜åˆ†é…ç›‘æ§ã€‚æ¯”å¦‚ï¼Œmallocå‡½æ•°ç”¨çš„æ˜¯ malloc_zone_mallocï¼Œcalloc ç”¨çš„æ˜¯ malloc_zone_callocã€‚</p><p>ä½¿ç”¨scalable_zone åˆ†é…å†…å­˜çš„å‡½æ•°éƒ½ä¼šè°ƒç”¨ malloc_logger å‡½æ•°ï¼Œå› ä¸ºç³»ç»Ÿæ€»æ˜¯éœ€è¦æœ‰ä¸€ä¸ªåœ°æ–¹æ¥ç»Ÿè®¡å¹¶ç®¡ç†å†…å­˜çš„åˆ†é…æƒ…å†µã€‚</p><p>å…·ä½“å®ç°çš„è¯ï¼Œä½ å¯ä»¥æŸ¥çœ‹ malloc_zone_malloc å‡½æ•°çš„å®ç°ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><pre><code>void *malloc_zone_malloc(malloc_zone_t *zone, size_t size)
{
	MALLOC_TRACE(TRACE_malloc | DBG_FUNC_START, (uintptr_t)zone, size, 0, 0);
	void *ptr;
	if (malloc_check_start &amp;&amp; (malloc_check_counter++ &gt;= malloc_check_start)) {
		internal_check();
	}
	if (size &gt; MALLOC_ABSOLUTE_MAX_SIZE) {
		return NULL;
	}
	ptr = zone-&gt;malloc(zone, size);
	// åœ¨ zone åˆ†é…å®Œå†…å­˜åå°±å¼€å§‹ä½¿ç”¨ malloc_logger è¿›è¡Œè¿›è¡Œè®°å½•
	if (malloc_logger) {
		malloc_logger(MALLOC_LOG_TYPE_ALLOCATE | MALLOC_LOG_TYPE_HAS_ZONE, (uintptr_t)zone, (uintptr_t)size, 0, (uintptr_t)ptr, 0);
	}
	MALLOC_TRACE(TRACE_malloc | DBG_FUNC_END, (uintptr_t)zone, size, (uintptr_t)ptr, 0);
	return ptr;
}
</code></pre><p>å…¶ä»–ä½¿ç”¨ scalable_zone åˆ†é…å†…å­˜çš„å‡½æ•°çš„æ–¹æ³•ä¹Ÿç±»ä¼¼ï¼Œæ‰€æœ‰å¤§å†…å­˜çš„åˆ†é…ï¼Œä¸ç®¡å¤–éƒ¨å‡½æ•°æ˜¯æ€ä¹ˆåŒ…è£…çš„ï¼Œæœ€ç»ˆéƒ½ä¼šè°ƒç”¨ malloc_logger å‡½æ•°ã€‚è¿™æ ·çš„è¯ï¼Œé—®é¢˜å°±å¥½è§£å†³äº†ï¼Œä½ å¯ä»¥ä½¿ç”¨ fishhook å» Hook è¿™ä¸ªå‡½æ•°ï¼ŒåŠ ä¸Šè‡ªå·±çš„ç»Ÿè®¡è®°å½•å°±èƒ½å¤Ÿé€šç›˜æŒæ¡å†…å­˜çš„åˆ†é…æƒ…å†µã€‚å‡ºç°é—®é¢˜æ—¶ï¼Œå°†å†…å­˜åˆ†é…è®°å½•çš„æ—¥å¿—æä¸Šæ¥ï¼Œä½ å°±èƒ½å¤Ÿè·Ÿè¸ªåˆ°å¯¼è‡´å†…å­˜ä¸åˆç†å¢å¤§çš„åŸå› äº†ã€‚</p><h2>å°ç»“</h2><p>ä¸ºäº†è¾¾åˆ°ç›‘æ§å†…å­˜çš„ç›®çš„ï¼Œæˆ‘ä»¬éœ€è¦åšä¸¤ä»¶äº‹æƒ…ï¼šä¸€æ˜¯ï¼Œèƒ½å¤Ÿæ ¹æ®ä¸åŒæœºå™¨å’Œç³»ç»Ÿè·å–åˆ°å†…å­˜æœ‰é—®é¢˜çš„é‚£ä¸ªæ—¶é—´ç‚¹ï¼›äºŒæ˜¯ï¼Œåˆ°äº†å‡ºç°å†…å­˜é—®é¢˜çš„é‚£ä¸ªæ—¶é—´ç‚¹æ—¶ï¼Œè¿˜èƒ½è¦å–åˆ°è¶³å¤Ÿå¤šçš„å¯ä»¥åˆ†æå†…å­˜é—®é¢˜çš„ä¿¡æ¯ã€‚</p><p>é’ˆå¯¹è¿™ä¸¤ä»¶äº‹ï¼Œæˆ‘åœ¨ä»Šå¤©è¿™ç¯‡æ–‡ç« é‡Œå’Œä½ åˆ†äº«äº†åœ¨ JetsamEvent æ—¥å¿—é‡Œã€åœ¨ XNU ä»£ç é‡Œã€åœ¨ task_info å‡½æ•°ä¸­æ€ä¹ˆå»æ‰¾å†…å­˜çš„ä¸Šé™å€¼ã€‚ç„¶åï¼Œæˆ‘å’Œä½ ä¸€èµ·åˆ†æäº†åœ¨å†…å­˜åˆ°è¾¾ä¸Šé™å€¼æ—¶ï¼Œæ€ä¹ˆé€šè¿‡å†…å­˜åˆ†é…æ—¶éƒ½ä¼šç»è¿‡çš„ malloc_logger å‡½æ•°æ¥æŒæ¡å†…å­˜åˆ†é…çš„è¯¦ç»†ä¿¡æ¯ï¼Œä»è€Œç²¾ç¡®å®šä½å†…å­˜é—®é¢˜ã€‚</p><p>è¯´åˆ°è¿™é‡Œä½ å¯èƒ½ä¼šå›è¿‡å¤´æ¥æƒ³ï¼Œä¸ºä»€ä¹ˆç”¨äºå ç”¨å†…å­˜è¿‡å¤§æ—¶ä¼šè¢«ç³»ç»Ÿå¼ºæ€å‘¢ï¼ŸmacOS æ‰“å¼€ä¸€å †åº”ç”¨ä¹Ÿä¼šè¿œè¶…ç‰©ç†å†…å­˜ï¼Œæ€ä¹ˆæ²¡è§ç³»ç»Ÿå»å¼ºæ€ macOS çš„åº”ç”¨å‘¢ï¼Ÿ</p><p>å…¶å®ï¼Œè¿™é‡Œæ¶‰åŠåˆ°çš„æ˜¯è®¾å¤‡èµ„æºçš„é—®é¢˜ã€‚è‹¹æœå…¬å¸è€ƒè™‘åˆ°æ‰‹æŒè®¾å¤‡å­˜å‚¨ç©ºé—´å°çš„é—®é¢˜ï¼Œåœ¨ iOS ç³»ç»Ÿé‡Œå»æ‰äº†äº¤æ¢ç©ºé—´ï¼Œè¿™æ ·è™šæ‹Ÿå†…å­˜å°±æ²¡æœ‰åŠæ³•è®°å½•åˆ°å¤–éƒ¨çš„å­˜å‚¨ä¸Šã€‚äºæ˜¯ï¼Œè‹¹æœå…¬å¸å¼•å…¥äº† MemoryStatus æœºåˆ¶ã€‚</p><p>è¿™ä¸ªæœºåˆ¶çš„ä¸»è¦æ€è·¯å°±æ˜¯ï¼Œåœ¨ iOS ç³»ç»Ÿä¸Šå¼¹å‡ºå°½å¯èƒ½å¤šçš„å†…å­˜ä¾›å½“å‰åº”ç”¨ä½¿ç”¨ã€‚æŠŠè¿™ä¸ªæœºåˆ¶è½åˆ°ä¼˜å…ˆçº§ä¸Šï¼Œå°±æ˜¯å…ˆå¼ºæ€åå°åº”ç”¨ï¼›å¦‚æœå†…å­˜è¿˜ä¸å¤Ÿå¤šå°±å¼ºæ€æ‰å½“å‰åº”ç”¨ã€‚è€Œåœ¨macOS ç³»ç»Ÿé‡Œï¼ŒMemoryStatus åªä¼šå¼ºæ€æ‰æ ‡è®°ä¸ºç©ºé—²é€€å‡ºçš„è¿›ç¨‹ã€‚</p><p>åœ¨å®ç°ä¸Šï¼ŒMemoryStatus æœºåˆ¶ä¼šå¼€å¯ä¸€ä¸ªmemorystatus_jetsam_thread çš„çº¿ç¨‹ã€‚è¿™ä¸ªçº¿ç¨‹ï¼Œå’Œå†…å­˜å‹åŠ›ç›‘æµ‹çº¿ç¨‹ vm_pressure_monitor æ²¡æœ‰è”ç³»ï¼Œåªè´Ÿè´£å¼ºæ€åº”ç”¨å’Œè®°å½•æ—¥å¿—ï¼Œä¸ä¼šå‘é€æ¶ˆæ¯ï¼Œæ‰€ä»¥å†…å­˜å‹åŠ›æ£€æµ‹çº¿ç¨‹æ— æ³•è·å–åˆ°å¼ºæ€åº”ç”¨çš„æ¶ˆæ¯ã€‚</p><p>é™¤å†…å­˜è¿‡å¤§è¢«ç³»ç»Ÿå¼ºæ€è¿™ç§å†…å­˜é—®é¢˜ä»¥å¤–ï¼Œè¿˜æœ‰ä»¥ä¸‹ä¸‰ç§å†…å­˜é—®é¢˜ï¼š</p><ul>
<li>è®¿é—®æœªåˆ†é…çš„å†…å­˜ï¼š XNU ä¼šæŠ¥ EXC_BAD_ACCESSé”™è¯¯ï¼Œä¿¡å·ä¸º SIGSEGV Signal #11 ã€‚</li>
<li>è®¿é—®å·²åˆ†é…ä½†æœªæäº¤çš„å†…å­˜ï¼šXNU ä¼šæ‹¦æˆªåˆ†é…ç‰©ç†å†…å­˜ï¼Œå‡ºç°é—®é¢˜çš„çº¿ç¨‹åˆ†é…å†…å­˜é¡µæ—¶ä¼šè¢«å†»ç»“ã€‚</li>
<li>æ²¡æœ‰éµå®ˆæƒé™è®¿é—®å†…å­˜ï¼šå†…å­˜é¡µé¢çš„æƒé™æ ‡å‡†ç±»ä¼¼ UNIX æ–‡ä»¶æƒé™ã€‚å¦‚æœå»å†™åªè¯»æƒé™çš„å†…å­˜é¡µé¢å°±ä¼šå‡ºç°é”™è¯¯ï¼ŒXNU ä¼šå‘å‡º SIGBUS Signal #7 ä¿¡å·ã€‚</li>
</ul><p>ç¬¬ä¸€ç§å’Œç¬¬ä¸‰ç§é—®é¢˜éƒ½å¯ä»¥é€šè¿‡å´©æºƒä¿¡æ¯è·å–åˆ°ï¼Œåœ¨æ”¶é›†å´©æºƒä¿¡æ¯æ—¶å¦‚æœå‘ç°æ˜¯è¿™ä¸¤ç±»ï¼Œæˆ‘ä»¬å°±å¯ä»¥æŠŠå†…å­˜åˆ†é…çš„è®°å½•åŒæ—¶ä¼ è¿‡æ¥è¿›è¡Œåˆ†æï¼Œå¯¹äºä¸åˆç†çš„å†…å­˜åˆ†é…è¿›è¡Œä¼˜åŒ–å’Œä¿®æ”¹ã€‚</p><h2>è¯¾åå°ä½œä¸š</h2><p>æˆ‘ä»Šå¤©æåˆ°äº†å®šä½å†…å­˜é—®é¢˜éœ€è¦è·å–æ›´å¤šçš„ä¿¡æ¯ï¼Œæ¯”å¦‚å†…å­˜åˆ†é…ã€‚é‚£ä¹ˆï¼Œè¯·ä½ æ¥æ ¹æ®æˆ‘ä»¬ä»Šå¤©æ‰€è®²çš„ hook malloc_logger çš„æ–¹æ³•ï¼Œæ¥å®ç°ä¸€ä¸ªè®°å½•å†…å­˜åˆ†é…çš„å°å·¥å…·å§ã€‚</p><p>æ„Ÿè°¢ä½ çš„æ”¶å¬ï¼Œæ¬¢è¿ä½ åœ¨è¯„è®ºåŒºç»™æˆ‘ç•™è¨€åˆ†äº«ä½ çš„è§‚ç‚¹ï¼Œä¹Ÿæ¬¢è¿æŠŠå®ƒåˆ†äº«ç»™æ›´å¤šçš„æœ‹å‹ä¸€èµ·é˜…è¯»ã€‚</p><p><img src="https://static001.geekbang.org/resource/image/f5/27/f5ee90aa0183a4bcc688980bd625eb27.jpg" alt=""></p><h2>ç²¾é€‰ç•™è¨€ï¼š</h2>
        <ul>
        
<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;line-height:1.2">
            ç™½å¼€äº†æ¯æ°´  2019-04-11 08:48:12
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">
            ä¸€ç›´ä¸çŸ¥é“å†…å­˜åˆ†é…æœ€å¤§å€¼è·å–å’Œæ€ä¹ˆè·å–å½“å‰å†…å­˜åˆ†é…ï¼Œçœ‹äº†æ–‡ç« è±ç„¶å¼€æœ—ï¼Œæƒ³é—®çš„æ˜¯ï¼Œè€å¸ˆè¿™äº›çŸ¥è¯†éƒ½æ˜¯é€šè¿‡åˆ†ææºç å¾—æ¥çš„å—ï¼Ÿ [6èµ]
        </div>
        
    </div>
</li>
            
<br/>

<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;line-height:1.2">
            80åç©ºå·¢è€è‚¥ç‹—  2019-04-11 09:30:16
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">
            info.resident_sizeè¿™ä¸ªè·å–çš„å†…å­˜å’Œxcodeä¸Šæ˜¾ç¤ºçš„å†…å­˜æ˜¯å¯¹ä¸ä¸Šçš„ã€‚ä¸çŸ¥é“æ‚¨æ€ä¹ˆçœ‹è¿™ä¸ªé—®é¢˜ï¼Ÿ [2èµ]
        </div>
        <br/>
<div>
    <div style="color:#888;font-size:15.25px;font-weight:400;line-height:1.2">ä½œè€…å›å¤2019-04-13 15:15:50</div>
    <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">ä½¿ç”¨çš„å­—æ®µä¸åŒï¼Œtask_vm_info_data_t è¿˜æœ‰ä¸ª phys_footprint ä»£è¡¨çš„å®é™…ä½¿ç”¨çš„ç‰©ç†å†…å­˜</div>
</div>
            
    </div>
</li>
            
<br/>

<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;line-height:1.2">
            Geek__Jaker  2019-04-16 11:14:56
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">
            æ¥ä¸Šé¢çš„é—®é¢˜ï¼Œé—®ä¸€ä¸‹è€å¸ˆï¼Œtask_vm_info_data_tçš„phys_footprint æ‰“å°è¾“å‡ºçš„å†…å­˜å€¼å’Œxcodeçš„æ˜¾ç¤ºå†…å­˜è¿˜æ˜¯ä¸ä¸€è‡´å•Šï¼Œè¿™æ˜¯æ€ä¹ˆå›äº‹ï¼Œæœ›è§£æƒ‘ï¼Œè°¢è°¢ã€‚ [1èµ]
        </div>
        
    </div>
</li>
            
<br/>

<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;line-height:1.2">
            drunkenMouse  2019-04-14 10:13:36
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">
            iOSé€šè¿‡å †æ ˆç®¡ç†æ‰€æœ‰çš„appè¿›ç¨‹ï¼Œé€šè¿‡ä¸€ä¸ªä¼˜å…ˆçº§æœ€é«˜çš„çº¿ç¨‹å»ç›‘æ§ç³»ç»Ÿå†…å­˜çš„å‹åŠ›ï¼Œè¿˜æœ‰ä¸€ä¸ªå¿«é€Ÿå¯¹ç…§è¡¨è®°å½•æ‰€æœ‰appçš„å†…å­˜ä½¿ç”¨æƒ…å†µã€‚å¦‚æœå†…å­˜æœ‰å‹åŠ›äº†ï¼Œå°±æŒ‰ç…§ä¼˜å…ˆçº§å»é‡Šæ”¾ä¼˜å…ˆçº§ä½è¿˜ä½¿ç”¨å†…å­˜å¤šçš„ã€‚<br><br>æ‰€ä»¥appå¾—å†…å­˜é˜ˆå€¼æ˜¯æ²¡æœ‰å›ºå®šå¤§å°çš„ã€‚æˆ‘ä¸€ç›´ä»¥ä¸ºæ¯ä¸ªappå¯ä»¥ä½¿ç”¨çš„å†…å­˜å¤§å°æ˜¯å›ºå®šçš„ã€‚ã€‚ 
        </div>
        
    </div>
</li>
            
<br/>

<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;line-height:1.2">
            Calabash_Boy  2019-04-13 17:42:53
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">
            è€å¸ˆå¥½,è¯»å®Œåæœ‰å‡ ä¸ªé—®é¢˜ä¸å¾—å…¶è§£:<br>(1) åœ¨ç›¸åŒçš„è®¾å¤‡å’Œç³»ç»Ÿç‰ˆæœ¬ä¸‹,æ¯ä¸ªAppçš„å†…å­˜é™åˆ¶æ˜¯ä¸ä¸€æ ·çš„ä¹ˆ?æˆ‘æŸ¥çœ‹äº†æ‰‹æœºçš„jetsamEvent,åœ¨per-process-limitä¸­å‘ç°ä¸€ä¸ªrpagesæ˜¯196.<br>(2) åœ¨vm_pressure_monitorçº¿ç¨‹çš„æ£€æµ‹ä¸‹,å‘ç°æŸAppæœ‰äº†å†…å­˜å‹åŠ›(ç†è§£ä¸ºå³å°†è¾¾åˆ°å†…å­˜é™åˆ¶),ç„¶åä¼šç»™è¯¥Appå‘é€šçŸ¥,ç„¶åæ‚¨åˆè®²åˆ°äº†ä¼˜å…ˆçº§æœºåˆ¶,è¿™å°±æœ‰ç–‘æƒ‘äº†,å½“æŸä¸ªAppæœ‰å‹åŠ›çš„æ—¶å€™,æ˜¯å¼ºæ€è¿™ä¸ªAppå‘¢è¿˜æ˜¯æ ¹æ®ä¼˜å…ˆçº§å»å¼ºæ€åå°çš„Appå‘¢?<br>(3) åœ¨æµ‹è¯•struct mach_task_basic_info info;è¿™æ®µä»£ç çš„æ—¶å€™,ç¼–è¯‘ä¼šæŠ¥é”™Definition of &#39;mach_task_basic_info&#39; must be imported from module &#39;Darwin.Mach.task_info&#39; before it is required,æ˜¯æˆ‘æ²¡æœ‰å¯¼å…¥æŸä¸ªå¤´æ–‡ä»¶ä¹ˆ? 
        </div>
        
    </div>
</li>
            
<br/>

<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;line-height:1.2">
            drunkenMouse  2019-04-13 10:58:57
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">
            ç³»ç»Ÿåœ¨å¼ºæ€Appå‰ï¼Œä¼šå…ˆåšä¼˜å…ˆçº§åˆ¤æ–­ã€‚æ„æ€æ˜¯ï¼šå¦‚æœä¼˜å…ˆçº§é«˜çš„è¯ï¼Œæœ¬æ¥ä¼šå¼ºæ€çš„ä¹Ÿä¸å¼ºæ€äº†ï¼Œè€Œå»å¼ºæ€é‚£äº›æ²¡æœ‰è¾¾åˆ°limitçš„è¿›ç¨‹ï¼Ÿ 
        </div>
        <br/>
<div>
    <div style="color:#888;font-size:15.25px;font-weight:400;line-height:1.2">ä½œè€…å›å¤2019-04-13 17:13:14</div>
    <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">å¼ºæ€å‰ç³»ç»Ÿä¼šæ ¹æ®æ–‡åçš„ç­–ç•¥åˆ¤æ–­åº”è¯¥ä¼˜å…ˆå¼ºæ€è°</div>
</div>
            
    </div>
</li>
            
<br/>

<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;line-height:1.2">
            drunkenMouse  2019-04-13 10:53:58
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">
            didReceivedMemory åŠ¨æ€è·å–å†…å­˜å€¼çš„æ–¹æ³•ï¼Œæ²¡æœ‰æ‰¾åˆ°å•Š å¤§ä½¬èƒ½è¯´ä¸€ä¸‹å—ï¼Ÿ 
        </div>
        <br/>
<div>
    <div style="color:#888;font-size:15.25px;font-weight:400;line-height:1.2">ä½œè€…å›å¤2019-04-13 17:14:52</div>
    <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">æ˜¯åœ¨ didReceiveMemoryWarning å›è°ƒé‡Œå»è·å–å½“å‰ Appå†…å­˜ä½¿ç”¨å€¼</div>
</div>
            
    </div>
</li>
            
<br/>

<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;line-height:1.2">
            drunkenMouse  2019-04-12 17:08:19
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">
            çº¿ç¨‹ä½¿ç”¨ä¼˜å…ˆçº§æ—¶ï¼ŒCPU å ç”¨å¤šçš„çº¿ç¨‹çš„ä¼˜å…ˆçº§ä¼šè¢«é™ä½ã€‚è¿™å¥è¯æ€ä¹ˆè¯»ä¸æ‡‚å‘¢ï¼Ÿ<br><br>åˆ©ç”¨didReceivedMemoryWarning è¿™ä¸ªä»£ç†æ—¶é—´ï¼Œçœ‹å¾—æˆ‘ä¸€æ„£ã€‚ã€‚åº”è¯¥æ˜¯ä»£ç†äº‹ä»¶ï¼Œæˆ‘è¿™ç®—ä¸ç®—é¸¡è›‹é‡Œé¢æŒ‘éª¨å¤´ï¼Ÿ<br><br>task_infkçš„ä½¿ç”¨éœ€è¦å¯¼å…¥&lt;mach&#47;mach.h&gt; <br><br>æœ€åä¸€æ®µæ„æ€æ˜¯ï¼Œç³»ç»Ÿé€šè¿‡malloc_loggeræ¥ç»Ÿè®¡å¹¶ç®¡ç†å†…å­˜çš„åˆ†é…æƒ…å†µï¼Ÿ 
        </div>
        <br/>
<div>
    <div style="color:#888;font-size:15.25px;font-weight:400;line-height:1.2">ä½œè€…å›å¤2019-04-13 10:44:42</div>
    <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">åœ¨ä½ è®¾ç½®ç›¸åŒä¼˜å…ˆçº§çš„çº¿ç¨‹ä¸­ï¼Œç³»ç»Ÿä¼šæœ‰æ›´ç»†çš„ä¼˜å…ˆçº§ç­–ç•¥ï¼Œè¿™ä¸ªç­–ç•¥å°±æ˜¯å“ªä¸ªçº¿ç¨‹ CPU å ç”¨é«˜ï¼Œä¼˜å…ˆçº§ä¼šæ¯”é™ä½</div>
</div>
            
    </div>
</li>
            
<br/>

<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;line-height:1.2">
            Hy  2019-04-12 12:08:43
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">
            ğŸ‘Œ 
        </div>
        
    </div>
</li>
            
<br/>

<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;line-height:1.2">
            mÎ±najay  2019-04-11 12:29:05
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">
            hook malloc_logger aopæ”¶é›†æ—¥å¿—ï¼Œç„¶ååœ¨OOMé‚£6ç§’å†…æ”¶é›†æ‰€æœ‰å†…å­˜åˆ†é…ä¿¡æ¯ï¼Œç„¶ååœ¨å†æ¬¡å¯åŠ¨åº”ç”¨æ—¶ ä¸ŠæŠ¥è¿™ä¸¤éƒ¨åˆ†æ—¥å¿—å—ï¼Ÿ <br>oomé‚£ä¸€åˆ»æ˜¯æŒ‡çš„å“ªä¸ªæ—¶æœºï¼Œæ¥å—å†…å­˜è­¦å‘Šï¼Ÿ didReceiveMemoryWarning ä¸­åˆ¤æ–­ æ˜¯å¦é è¿‘ limitå—  
        </div>
        <br/>
<div>
    <div style="color:#888;font-size:15.25px;font-weight:400;line-height:1.2">ä½œè€…å›å¤2019-04-13 15:07:36</div>
    <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">OOM æ˜¯å†…å­˜è¶…æ ‡è¢«ç³»ç»Ÿå¼ºæ€æ—¶</div>
</div>
            
    </div>
</li>
            
<br/>

<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;line-height:1.2">
            æµ©  2019-04-11 11:55:19
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">
            ä¸€ç›´ä¸çŸ¥é“å†…å­˜åˆ†é…æœ€å¤§å€¼è·å–å’Œæ€ä¹ˆè·å–å½“å‰å†…å­˜åˆ†é…ï¼Œçœ‹äº†æ–‡ç« è±ç„¶å¼€æœ—ï¼Œæƒ³é—®çš„æ˜¯ï¼Œè€å¸ˆè¿™äº›çŸ¥è¯†éƒ½æ˜¯é€šè¿‡åˆ†ææºç å¾—æ¥çš„å—ï¼Ÿ 
        </div>
        
    </div>
</li>
            </ul>
</div>
</body>
</html>